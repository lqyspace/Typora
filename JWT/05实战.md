[toc]

## 1、JWT工具类

```java
/**
 * @ClassName: JWTUtils
 * @Description:
 * @Author: Lengqy
 * @Date: 2024/11/3 18:59
 **/
public class JWTUtils {
    private static final String SIGN = "hdak@3%^usdabskrbaid";
    /*
    * 生成token  header.payload.signature
    * */
    public static String getToken(Map<String, String> map) {
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.DATE, 7); // 默认7天过期

        // payload
        JWTCreator.Builder builder = JWT.create();
        map.forEach(builder::withClaim);
//        map.forEach((k, v) -> builder.withClaim(k, v));

        // 指定过期时间
        builder.withExpiresAt(calendar.getTime());

        // sign
        String token = builder
                .sign(Algorithm.HMAC256(SIGN)); // 签名
        return token;
    }


    // 验证token
    public static DecodedJWT verifyToken(String token) {
        return JWT.require(Algorithm.HMAC256(SIGN)).build().verify(token);
    }
}
```

## 2、自定义一个拦截器

自定义一个拦截器，实现HandlerInterceptor接口：

```java
/**
 * @ClassName: JWTInterceptor
 * @Description:
 * @Author: Lengqy
 * @Date: 2024/11/3 20:57
 **/
public class JWTInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // 获取请求头中的令牌
        Map<String, Object> map = new HashMap<>();
        String token = request.getHeader("token");
        try {
            JWTUtils.verifyToken(token);
            return true;
        } catch (Exception e) {
            e.printStackTrace();
            map.put("msg", e.getMessage());
        }
        map.put("state", false);
        String s = new ObjectMapper().writeValueAsString(map);
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().println(s);
        return false;
    }
}
```

## 3、添加配置Config

将自定义的拦截器添加进去

```java
@Configuration
public class InterceptorConfig implements WebMvcConfigurer {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new JWTInterceptor())
                .addPathPatterns("/**") // 其他的接口token验证
                .excludePathPatterns("/portal/user/login"); // 用户接口放行
    }
}
```

## 4、控制器进行测试

```java
@RestController
@RequestMapping("/portal")
@Slf4j
public class UserController {
    @Autowired
    private UserService userService;

    @RequestMapping(method = RequestMethod.POST, value = "/user/login")
    public Map<String, Object> login(@RequestBody User user){
        log.debug("用户名：[{}]", user.getUserName());
        log.debug("公钥：[{}]", user.getPubKey());
        Map<String, Object> map = new HashMap<>();
        try {
            User login = userService.login(user);
            map.put("state","ok");
            map.put("msg", "登陆成功!");
            map.put("data", login);
            Map<String, String> payload = new HashMap<>();
            payload.put("userName", login.getUserName());
            // 生成令牌
            String token = JWTUtils.getToken(payload);
            map.put("token", token);
        } catch (Exception e) {
            map.put("state", "fail");
            map.put("msg", e.getMessage());
            log.debug("e: {}", e);
        }
        return map;
    }

    @RequestMapping(method = RequestMethod.POST, value = "/user/test")
    public Map<String, Object> test(){
        Map<String, Object> map = new HashMap<>();
        // 处理自己的业务逻辑
        map.put("state", true);
        map.put("msg", "请求成功！");
        return map;
    }
}
```

## 5、github地址

[https://github.com/lqyspace/JWTDemo](https://github.com/lqyspace/JWTDemo)

