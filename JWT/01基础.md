[toc]

## 1、什么是JWT

> 介绍

JSON WEB Token(JWT)是一个开放标准（rfc7519），它定义了一种紧凑的、自包含的付方式，用于在各方之间yiJSON对象安全的传输信息。此信息可以验证和信任，因为他是数字签名的。jwt可以使用密钥（使用HMAC算法）或者使用RSA或ECDSA的公钥/私钥对其进行签名

JWT简称JSON WebToken，也就是通过JSON形式作为WEB应用中的令牌，用于在各方之间安全地将信息作为JSON对象传输。在数据传输过程中还可以完成数据加密、签名等相关处理。

> JWT能做什么

1、授权

这是使用JWT最常见的场景，一旦用户登录，后续每一个请求都需要包括JWT，从而允许用户访问该令牌允许的路由，服务和资源。单点登录是当今广泛使用JWT的一项功能，因为它的开销很小并且可以在不同的域中轻松使用。（跨域）

2、信息交换

jwt是各方安全进行信息交换的好方法。因为可以对jwt进行签名（例如，使用公钥/私钥对），所以可以确保发件人是值得信任的。此外，由于签名是使用头和有效负载计算的，因此还可以验证内容是否被遭到篡改。

## 2、为什么是JWT

> 1、基于传统的session认证

我们知道，http协议状态本身一种无状态的协议，而这就意味着如果用户向我们的应用提供了用户名和密码来进行用户登录认证，那么下一次请求使，用户还要再进行一次用户登录认证才行。因为根据http的协议，我们并不知道是哪一个用户发出的请求，所以为了让我们的应用能识别到哪个用户发出的请求，我们只能在服务器存储一份用户登录的信息，这份信息会在响应时传递给浏览器，告诉其保存为cookie，以便下次请求时再发给我们的应用，这样我们的应用就可以分辨请求是来自哪一个用户，这就是基于session的传统认证方式。

![image-20241102175031181](https://fastly.jsdelivr.net/gh/lqyspace/mypic@master/img1/202411021750767.png)

> 2、暴露的问题

1、每个用户经过我们的应用认证之后，我们的应用都要在服务端做一次记录，以方便用户下次请求的鉴别，通常而言session都是保存在内存中，而随着认证用户的增多，服务端的开销也会越来越大。

2、用户认证之后，服务端做认证记录，如果认证的记录被保存在内存中的话，这意味着用户下次请求还必须将请求落在这台服务器上，这样才能拿到授权的资源，如果是在分布式的应用上，将大大限制负载均衡的能力，这也意味限制了应用的扩展能力。

3、因为是基于cookie进行用户识别的，cookie如果被截获，用户就会很容易受到跨站请求伪造的攻击。

4、在前后端分离的应用中更加痛苦，如图所示。

![image-20241102180532528](https://fastly.jsdelivr.net/gh/lqyspace/mypic@master/img1/202411021805557.png)

也就是说前后端分离在应用解耦后增加了部署的复杂性。通常用户的一次请求就需要转发多次，如果使用session，那么每次转发都需要携带session到服务器，服务器还需要查询用户信息。同时如果用户很多，这些信息存储在服务器的内存中将大大增加服务器的负担。另外，如果遇到CSRF（跨站伪造请求攻击），由于session是基于cookie进行用户识别的，cookie如果被截获，用户就会很容易受到跨站伪造请求攻击。还有就是session是一个特征值，表达的信息不够丰富，不容易被扩展。而且如果你后端应用是多节点部署，那么就需要实现session共享机制，而不方便集群应用。

> 3、基于JWT的应用

![image-20241102181716167](https://fastly.jsdelivr.net/gh/lqyspace/mypic@master/img1/202411021817200.png)

- 首先，前端通过web表单将自己的用户名和密码发送到后端的接口。这一过程一般是一个http post请求。建议的方式是通过SSL加密传输（https），从而避免敏感信息被嗅探。
- 后端核对用户名和密码成功后，用户的id等其他信息作为JWT payload（负载），将其与头部分别进行Base64编码拼接后签名，形成一个JWT（token  head.payload.signature）。形成的jwt是一个形同lll.zzz.xxx的字符串。
- 后端将jwt字符串作为登陆成功的返回结果给前端。前端可以将返回的结果保存至localStorage或sessionStorage上，退出登录时前端删除保存的JWT即可。
- 前端在每次请求时将jwt放入http的header中的Authorization位。（解决XSS或XSRF问题）
- 后端检查是否存在，如存在验证JWT的有效性。例如检查签名是否正确，检查token是否过期；检查token的接收方是否是自己（可选）
- 验证通过后后端使用jwt中保存的用户信息进行其他逻辑的操作，返回相应的结果。

> 4、jwt的优势

1. 简洁（Compact）：可以通过URL，POST参数或者在HTTP header发送，因为数据量小，传输速度也快
2. 自包含（Self-contained）：负载中包含了所有用户所需要的信息，避免了多次查询数据库
3. 因为Token是以JSON的形式保存在客户端的，所以JWT是跨语言的，原则上任何web形式都支持
4. 不需要在服务端保存会话信息，特别适用于分布式微服务。

