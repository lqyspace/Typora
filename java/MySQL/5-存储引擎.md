# 05-存储引擎

为了管理方便，人们把`连接管理，查询缓存，语法解析，查询优化`这些并不涉及真实数据存储的功能划分为MYSQL Server的功能，那真实存储数据的功能划分为`存储引擎`的功能。所以在MySQL server完成了查询优化以后，只需按照生成的`执行计划`调用底层存储引擎提供的API，获取数据返回给客户端即可。

存储引擎的概念，简而言之，就是表的类型。其实存储引擎以前叫做表处理器，后来改名为存储引擎，它的功能就是接受上层传下来的指令，然后对表中的数据进行提取或写入操作。

## 1 查看存储引擎

```MySQL
show engines;
```

![image-20231002215208313](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310022152371.png)

```mysql 
show engines \G;
```

显示如下：

![image-20231002215246502](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310022152551.png)



## 2 查看系统默认的存储引擎

- 查看默认的存储引擎

  ```MySQL
  show variables like '%storage_engines';
  或
  select @@default_storage_engines;
  ```

  ![image-20231002215553009](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310022155077.png)

  ![image-20231002215607625](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310022156704.png)

- 修改默认的存储引擎

  如果在创建表的语句中没有显示指定表的存储引擎的话，那就会默认使用Innodb作为表的存储引擎。如果我们想改变表的默认存储引擎的话，可以这样写启动服务器的命令：

  ```MySQL
  set default_storage_engine=MyISAM;
  ```

  或者修改配置文件my.cnf

  ```mysql
  default-storage-engine=MyISAM
  
  # 重启服务
  systemctl restart mysqld.service
  ```



## 3 设置表的存储引擎

存储引擎是负责对表中的数据进行提取和写入工作的，我们可以为==不同的表设置不同的存储引擎==，也就是说不同的表可以有不同的物理存储结构，不同的提取和写入方式。

### 3.1 创建表时指定存储引擎

我们之前创建表时都没有指定存储引擎，那么就会使用默认的存储引擎Innodb。如果我们想显式的指定一下表的存储引擎，那么可以这样写：

```MySQL
create table 表名(
	建表语句
)engine=存储引擎名称;
```

### 3.2 修改表的存储引擎

如果表已经存在，那么也可以使用下面的语句修改存储引擎。

```MySQL
alter table 表名 engine=存储引擎名称;
```

比如我们修改一下engine_demo_table的表结构：

```MySQL
alter table engine_demo_table engine=Innodb;
```

这是我们再查看一下engine_demo_table的表结构：

```MySQL
show create table engine_demo_table \G;
*************************** 1. row ***************************
Table: engine_demo_table
Create Table: CREATE TABLE `engine_demo_table` (
`i` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8
1 row in set (0.01 sec)
```



## 4 引擎介绍

外键的功能在具体开发中不建议使用，一般是在应用层用具体的代码做限制，因为外键的特性会影响数据库的性能。

### 4.1 Innodb引擎：具备外键支持功能的事务存储引擎

- MySQL从3.23.34a开始就包含InnodB存储引擎。==大于等于5.5之后，默认采用Innodb引擎==。
- Innodb是MySQL的默认事务型引擎，它被设计用来处理大量的短期（short-live）事务。可以确保事务的完整提交（commit）和回滚（rollback）。
- 除了增加（insert）和查询（select）外，还需要更新（update）、删除（delete）操作，那么，应优先选择Innodb存储引擎。
- ==除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑Innodb存储引擎。==
- 数据文件结构：
  - 表名.frm存储表结构（MySQL8.0时，合并在表名.ibd中，所以没有.frm文件）
  - 表名.ibd存储数据和索引
- Innodb是==为处理巨大数据量的最大性能设计==。
  - 在以前的版本中，字典数据以元数据文件，非事务表等来存储。现在这些元数据文件被删除了。比如：`.frm`，`.par`，`.trn`，`.isl`，`db.opt`等都在MySQL8中不复存在。
- 对比MyISAM的存储引擎，==Innodb写的处理效率差一些，并且会占用更多的磁盘空间以保存数据和索引==。
- MyISAM只缓存索引，不缓存真实数据；Innodb不仅缓存索引还要缓存真实数据，==对内存要求较高，==并且内存大小对性能有决定性的影响。



### 4.2 MyISAM引擎：主要的非事务处理存储引擎

- MYISAM提供了大量的特性，包括全文索引，压缩，空间函数（GIS）等，但MyISAM==不支持事务，行级锁，外键==，有一个毫无疑问的缺陷就是==崩溃后无法安全恢复==。
- 5.5之前默认的存储引擎
- 优势是==访问速度快==，对事物完整性没有要求或者以select，insert为主的应用
- 针对数据统计有额外的常数存储，故而count(*)的查询效率高
- 数据文件结构：
  - 表名.frm存储表结构
  - 表名.MYD存储数据结构(MYData)
  - 表名.MYI存储索引(MYIndex)
- 应用场景：只读应用或者以读为主的业务



### 4.3 Archive引擎：用于数据存档

- `archive`是`归档`的意思，仅仅支持 `插入` 和 `查询` 两种功能（行被插入后不能再修改）。

- 在MySQL5.5以后 `支持索引` 功能。

- 拥有很好的压缩机制，使用==zlib==压缩库，在记录请求的时候实时的进行压缩，经常被用来作为仓库使用。

- 创建archive表时，存储引擎会创建已表名开头的文件。数据文件的扩展名为 `.arz`。

  - 下图为MySQL5.7的截图

  ![image-20231003112554028](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031125132.png)

- 根据英文的测试结论来看，同样数据量下，archive表比MYISAM表要小大约75%，比支持事务处理的InnodB表小大约83%。

- ==archive存储引擎采用行级锁==。该archive引擎支持auto_increment列属性，==auto_increment列可以具有唯一索引或非唯一索引==。尝试在任何其他列上创建索引会导致错误（==在其他的不是auto_increment的列上创建索引就会报错==）。

- archive表适合==日志和数据采集（归档）==类应用；适合存储大量的独立的作为历史记录的数据。拥有很高的插入速度，但是对查询的支持较差。

- 下表展示archive存储引擎功能

  ![image-20231003102235179](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031022248.png)



### 4.4 Blackhole引擎：丢弃写操作，读操作会返回空内容

- Blankhole引擎没有实现任何存储机制，它会丢弃所有插入的数据，不做任何保存。
- 但是服务器会记录Blankhole表的日志，所以可以用于复制数据到备库，或者简单的记录到日志。但这种应用方式会碰到很多问题，因此并不推荐。
  - 下图为MySQL5.7的截图

![image-20231003112726689](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031127762.png)

### 4.5 CSV引擎：存储数据时，以逗号分割各个数据项

- csv引擎可以将普通的csv文件当做数据表来处理，但不支持索引。
- csv引擎可以作为一种`数据交换的机制`，非常有用
- csv存储的数据直接可以在操作系统里，用文本编辑器，或者excel读取。
- 对于数据的快速导入，导出有明显优势。

创建csv表时，服务器会创建一个纯文本数据文件，其名称以表名开头并带有 `.csv`扩展名，当你将数据储存到表中时，存储引擎将其以逗号分隔值的格式保存到数据文件中。

==创建表时，字段名必须设置为非空，否则会报错==。

![image-20231003105632201](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031056248.png)

![image-20231003105650394](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031056431.png)

在MySQL5.7中：除了有 `.csm`文件和 `.csv`文件，还是具有 `.frm`表文件的

![image-20231003105955644](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031059746.png)

在MySQL8.0中则是：

![image-20231003110054148](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031101647.png)



### 4.6 Memory引擎：置于内存的表

**概述：**

Memory采用的逻辑介质是内存，响应速度快，但是当mysqld守护进程崩溃时数据会丢失。另外要求存储的数据是长度不变的格式，比如，Blob和text类型的数据是不可用的（长度不固定）。

**主要特征：**

- Memory同时支持哈希（HASH）索引和B+树索引
  - 哈希索引比较是否相等时会比较快，但是对于范围的比较会比较慢。
  - 默认使用哈希索引（HASH）索引，其速度比B+树索引快
  - 如果希望使用B+树索引，可以在创建索引是选择使用
- Memory表至少比MyISAM表要快一个数量级。
- Memory表的大小是受限制的。表的大小只要取决于两个参数，分别是max_rows和max_heap_table_size。其中，max_rows可以在创建表时指定；max_heap_table_size的大小默认是16MB，可以按照需要进行扩大。
- 数据文件与索引文件分开存储。
  - 每个基于memory存储引擎的表实际对应一个磁盘文件，该文件的文件名与表名相同，类型为frm文件，该文件只存储表结构，而其数据文件都是存储在内存中的。
  - 这样有利于表的快速访问，提供整个表的处理效率。
- 缺点：其数据易丢失，生命周期短。基于这个缺陷，选择Memory存储引擎时需要特别小心。

**使用Memory存储引擎的场景：**

- ==目标数据比较小==，而且非常频繁地进行访问，在内存中存放数据，如果数据太大会造成内存溢出。可以通过参数 `max_heap_table_size` 控制Memory表的大小，限制Memory表的最大的大小。
- 如果==数据是临时的==，而且 `必须立即可用` 得到，那么就可以放在内存中。
- 存储在memory表中的数据如果突然间 `丢失的话也没有太大关系`。



### 4.7 Federated引擎：远程访问表

- Federated引擎是访问其它MySQL服务器的一个代理，尽管该引擎看起来提供了一种很好的跨服务器的灵活性，但也经常带来问题，因此默认是禁用的。



### 4.8 Merge引擎：管理多个MyISAM表构成的集合

### 4.9 NDB引擎：MYISAM集群专用存储引擎

也叫作NDB Cluster存储引擎，主要用于MySQL CLuster 分布式集群环境，类似于Oracle的RAC集群。

### 4.10 引擎对比

![image-20231003115237550](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031152621.png)

![image-20231003115256318](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031152365.png)

![image-20231003115315381](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031153431.png)



## 5 MYISAM和InnodB

![image-20231003133922829](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031339879.png)

## 6 阿里巴巴，淘宝用哪个

![image-20231003134040550](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031340593.png)

- Percona为MySQL数据库服务器进行了改进，在功能和性能上较MySQL有着显著提升
- 该版本提升了在高负载情况下的InnodB的性能，为DBA提供了一些非常有用的性能诊断工具；另外有更多的参数和命令来控制服务器行为。
- 该公司新建了一款存储引擎叫Xtradb完全可以替代InnodB，并且在性能和并发上做得更好
- 阿里巴巴大部分MySQL数据库其实使用的是percona的原型加以修改



## 课外补充

### 1 Innodb表的优势

InnodB存储引擎在实际应用有诸多的优势，比如操作便利，提高了数据库的性能，维护成本低等。如果由于硬件或者软件的原因导致服务器崩溃，那么在重启服务器之后不需要进行额外的操作。InnodB崩溃恢复功能自动将之前的提交的内容定型，然后撤销没有提交的进程，重启之后继续从崩溃点开始执行。

![image-20231003135009941](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031350026.png)

![image-20231003135037137](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031350190.png)

![image-20231003135100371](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202310031351589.png)