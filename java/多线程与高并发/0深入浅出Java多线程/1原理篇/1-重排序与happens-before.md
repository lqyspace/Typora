[TOC]

# 重排序与happens-before

# 1 什么是重排序

计算机在执行程序时，为了提高性能，编译器和处理器常常会对指令进行重排。

**为什么指令重排序可以提高性能？**

简单的说，每一个指令都包含多个步骤，每个步骤可能使用不同的硬件。因此，**流水线技术**产生了，它的原理是指令1还没有执行完，指令2就可以开始执行，而不用等到指令1执行结束在执行指令2，这就大大提高了效率。

> Note
>
> 什么是流水线技术？
>
> - 流水线技术是指在程序执行时，多条指令重叠进行操作的一种准并行处理实现技术。
> - 通俗的讲，将一个时序任务，分解成若干顺序执行的子任务，不同的子任务由不同的执行机构来负责执行，而这些执行机构可以同时并行工作。
>
> ![img](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202308160147239.png)
>
> 这幅图表达的意思是，有4个任务，每个任务可以被分为5个子任务。t1时刻可以执行取指令，t2时刻可以执行取指令和指令译码，t3时刻可以执行取指令，指令译码和取操作数，以此类推。
>
> - 假定某种类型的任务，可以分为N个子任务，每个子任务需要时间t，则完成该任务需要时间 Nt
> - 若以传统的方式，完成k个任务所需的时间是kNt
> - 使用流水线技术，花费的时间是Nt+(k-1)t
> - 注意，如果每个子任务所需的时间不同，其时间取决于执行顺序中最慢的那一个



但是，流水线技术最害怕中断，恢复中断的代价是比较大的，所以我们要想尽办法不让流水线中断。指令重排就是减少中断的一种技术。

