[TOC]

# 4.13 拔掉网线后，原本的TCP连接还存在吗

问：==拔掉网线几秒钟，再插回去，原本的TCP连接还存在吗？==

有的同学可能就会以为，网线被拔掉了，那说明物理层断开连接了，那在上层的传输层理应也会被断开，所以原本的TCP理解就不会存在了的。

这个想法是错误的！！！

上面这个想法的问题在于，错误地认为拔掉网线的动作会影响传输层，事实上并不影响。

实际上，TCP连接在Linux内核中是一个名为 `struct socket` 的结构体，该结构体的内容包含TCP连接的状态等信息。等拔掉网线的时候，操作系统并不会变更结构体的任何内容，所以TCP的连接状态是不会改变的。

我在我的电脑上做了个小实验，我用 ssh 终端连接了我的云服务器，然后我通过断开 wifi 的方式来模拟拔掉网线的场景，此时查看 TCP 连接的状态没有发生变化，还是处于 ESTABLISHED 状态。

![图片](https://raw.githubusercontent.com/lqyspace/mypic/master/PicBed/202309230036251.png)

通过上面的实验，我们可以得知，拔掉网线的动作并不会影响TCP的连接状态。

接下来，要看拔掉网线后，双方都做了什么。

所以针对这个问题，我们需要分场景讨论：

- 拔掉网线后，有数据传输
- 拔掉网线后，没有数据传输



## 拔掉网线后，有数据传输

在客户端拔掉网线后，服务端向客户端发送的数据报文会得不到任何的响应，在等待一定时长后，服务端就会触发**超时重传**机制，重传未得到响应的数据报文。

**如果在服务端重传报文的过程中，客户端刚好把网线插回去**，由于拔掉网线并不会改变客户端的TCP连接状态，并且还是处于ESTABLISHED状态，所以这是客户端是可以正常接受服务端发来的数据报文的，然后客户端就会回ACK响应报文了。

此时，客户端和服务端的TCP连接依然存在的，就感觉什么事都没有发生。

但是，如果在服务端重传报文的过程中，客户端一直没有将网线插入回去，服务端超时重传报文的次数达到一定的阈值后，内核就会判定出该TCP有问题，然后通过Socket接口告诉应用程序该TCP连接出问题了，于是服务端的TCP连接就会断开。

而等客户端插回网线后，如果客户端向服务端发送了数据，由于服务端已经没有与客户端相同四元组的TCP连接了，因此服务端内核就会回复RST报文，客户端收到后就会释放该TCP连接。

此时，客户端和服务端的TCP连接都已经断开了。

> **那TCP的数据报文具体重传几次呢？**

在Linux系统中，提供了一个叫tcp_retries2配置项，默认值是15，如下图：

![图片](https://cdn.xiaolincoding.com//mysql/other/f92c00c7e9cd01e89326e943232e5f04.png)

这个内核参数是控制，在TCP连接建立的情况下，超时重传的最大次数。

